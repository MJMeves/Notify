<!DOCTYPE html>
<html>
<head>
<title>Listener Page</title>
<style>
  .card{padding:10px;border:1px solid #ccc;margin:6px;border-radius:8px;}
  button{margin-top:4px;padding:6px;}
</style>
</head>
<body>

<nav>
  <ul>
    <li><a href="queries.html">5 Queries</a></li>
    <li><a href="index.html">Logout</a></li>
  </ul>
</nav>

<h1>Listener #<span id="listener-id"></span></h1>

<div id="profile"></div>
<h3><u>Your Loyalty Level</u></h3>
<p id="loyalty"></p>

<hr>

<h2>Favorite an Artist</h2>
<input id="favArtist" placeholder="Enter ArtistID">
<button onclick="favoriteArtist()">Save Artist</button>

<h2>Favorite a Song</h2>
<input id="favSong" placeholder="Enter SongID">
<button onclick="favoriteSong()">Save Song</button>

<hr>

<h2>Play A Song</h2>
<input id="songPlay" placeholder="SongID to Play">
<button onclick="playSong()">Play</button>
<p id="playStatus"></p>

<hr>

<h2>Top 5 Favorited Artists</h2>
<div id="top-artists"></div>

<h2>Top 5 Favorited Songs</h2>
<div id="top-songs"></div>

<p><a href="index.html">Logout</a></p>

<script>
const id = localStorage.getItem("userId");
document.getElementById("listener-id").textContent=id;


// ---------- Load Profile ----------
fetch(`/api/listener-simple?userId=${id}`)
.then(r=>r.json()).then(x=>{
 if(!x.success)return;
 const a=x.data;
 document.getElementById("profile").innerHTML=
 `<p>Name: ${a.FirstName} ${a.LastName}</p>
  <p>Username: ${a.UserName}</p>
  <p>Minutes: ${a.MinutesListened}</p>
  <p>Favorite Song: ${a.FavoriteSongName||'None'}</p>
  <p>Favorite Artist ID: ${a.FavoriteArtistID||'None'}</p>`;
});

// ---------- Loyalty Level ----------
fetch(`/api/loyalty-level?userId=${id}`)
.then(r=>r.json()).then(x=>{
 if(x.success)document.getElementById("loyalty").textContent=x.level;
});

// ---------- SAVE FAVORITES ----------
function favoriteSong(){
 fetch("/api/favorite-song",{
  method:"POST",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({userId:id,songId:favSong.value})
 })
 .then(r=>r.json())
 .then(x=>{
   alert("Favorited Song: " + x.songName);
   loadTopFavorites();    // refresh card lists live
   loadProfile();         // updates "favorite song" text
 });
}

function favoriteArtist(){
 fetch("/api/favorite-artist",{
  method:"POST",
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({userId:id,artistId:favArtist.value})
 })
 .then(r=>r.json())
 .then(x=>{
   alert("Favorited Artist: " + x.artistName);
   loadTopFavorites();
   loadProfile();
 });
}

// ---------- PLAY ----------
function playSong(){
  const id = songPlay.value.trim();   // <‚Äî removes whitespace
  fetch("/api/play",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({songId:id})
  })
  .then(r=>r.json())
  .then(x=>{
    document.getElementById("playStatus").textContent =
        "Played: " + (x.songName ?? "Not Found");
    loadTopFavorites();
  });
}


// ---------- TOP 5 DISPLAY ----------
fetch("/api/top-artists").then(r=>r.json()).then(x=>{
 if(!x.success)return;
 x.data.forEach(a=>{
 document.getElementById("top-artists").innerHTML+=
 `<div class="card">${a.StageName} ‚Äî ${a.ListenerCount}</div>`;
 });
});

fetch("/api/top-songs").then(r=>r.json()).then(x=>{
 if(!x.success)return;
 x.data.forEach(s=>{
 document.getElementById("top-songs").innerHTML+=
 `<div class="card">${s.SongName} ‚Äî ${s.ListenerCount}</div>`;
 });
});

// ---------- Refresh Helpers ----------
  function loadTopFavorites(){
    const artistBox = document.getElementById("top-artists");
    const songBox   = document.getElementById("top-songs");

    artistBox.innerHTML = "";
    songBox.innerHTML   = "";

    fetch("/api/top-artists").then(r=>r.json()).then(x=>{
      x.data?.forEach(a=>{
        artistBox.innerHTML += `<div class="card">${a.StageName||'(No Stage Name)'} ‚Äî ‚ù§Ô∏è ${a.ListenerCount}</div>`;
      });
    });

    fetch("/api/top-songs").then(r=>r.json()).then(x=>{
      x.data?.forEach(s=>{
        songBox.innerHTML += `<div class="card">${s.SongName} ‚Äî üéß ${s.ListenerCount}</div>`;
      });
    });
  }


  function loadProfile(){
    fetch(`/api/listener-simple?userId=${id}`).then(r=>r.json()).then(x=>{
      const a=x.data;
      profile.innerHTML=
      `<p>Name: ${a.FirstName} ${a.LastName}</p>
        <p>Username: ${a.UserName}</p>
        <p>Minutes: ${a.MinutesListened}</p>
        <p>Favorite Song: ${a.FavoriteSongName||'None'}</p>
        <p>Favorite Artist ID: ${a.FavoriteArtistID||'None'}</p>`;
    });
  }
</script>
</body>
</html>

